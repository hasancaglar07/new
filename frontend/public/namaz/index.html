<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Namaz Vakitleri (Mobil)</title>
    <meta name="theme-color" content="#177267" />
    <link rel="icon" href="/mihmandar-logo.svg" type="image/svg+xml" />
    <!-- Performance hints -->
    <link rel="preconnect" href="https://vakit.vercel.app" crossorigin>
    <link rel="dns-prefetch" href="https://vakit.vercel.app">
    <link rel="preconnect" href="https://new-production-1016.up.railway.app" crossorigin>
    <link rel="dns-prefetch" href="https://new-production-1016.up.railway.app">
    <style>
      :root{--bg:#ffffff;--surface:#ffffff;--text:#0f172a;--muted:#475569;--primary:#177267;--primary-600:#106e60;--accent:#ffc574}
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
      .container{padding:18px 14px 28px 14px;max-width:640px;margin:0 auto}
      .header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
      .brand{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:#ffffff;border:1px solid #e9edf1}
      .title{font-weight:800;color:var(--primary)}
      .badge{margin-left:auto;font-size:12px;color:var(--muted)}
      .logo-spin{animation:spin 14s linear infinite}
      @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
      .card{border:1px solid #e9edf1;border-radius:14px;padding:16px;margin-top:12px;box-shadow:0 1px 3px rgba(2,6,23,0.04);background:#fff}
      .row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f1f5f9}
      .row:last-child{border-bottom:none}
      .row label{font-weight:600;color:#0f172a}
      .row input[type="number"]{border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;background:#fff;color:#0f172a}
      input,button{accent-color:var(--primary)}
      .k{font-weight:700;color:var(--primary)}
      .v{font-family:monospace;font-weight:700}
      .next{display:flex;align-items:center;gap:10px;padding:14px 16px;border-radius:12px;background:#f3faf8;color:#0f172a;border:1px solid #d8eee9;font-weight:800;margin-top:8px}
      .muted{color:var(--muted);font-size:13px;margin-top:8px}
      .toolbar{display:flex;gap:10px;margin-top:12px}
      .btn{flex:1;background:var(--primary);color:#fff;border:none;border-radius:12px;padding:12px;font-weight:800;letter-spacing:.2px;box-shadow:0 4px 10px rgba(23,114,103,.12);transition:transform .06s ease}
      .btn:active{transform:translateY(1px)}
      .btn.secondary{background:#0ea5e9;box-shadow:0 6px 16px rgba(14,165,233,.15)}
      .btn.warn{background:#f59e0b;box-shadow:0 6px 16px rgba(245,158,11,.15)}
      .btn.big{padding:16px;font-size:16px}
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px}
      .cell{display:flex;flex-direction:column;justify-content:center;align-items:center;height:86px;border:1px solid #e3ece8;border-radius:14px;padding:8px 8px;text-align:center;background:linear-gradient(180deg,#ffffff,#f7faf9);box-shadow:0 1px 2px rgba(2,6,23,.04);position:relative;overflow:hidden}
      .cell:after{content:"";position:absolute;inset:0;border-radius:14px;background:radial-gradient(60% 40% at 50% 0%, rgba(23,114,103,.08), transparent);pointer-events:none}
      .cell .n{font-size:13px;color:#177267;font-weight:800;letter-spacing:.3px;display:flex;align-items:center;justify-content:center;gap:6px}
      .cell .n .i{font-size:16px;line-height:1}
      .cell .t{font-family:monospace;font-weight:900;font-size:20px;line-height:1.1;color:#000000 !important;opacity:1;margin-top:6px}
      .footer{margin-top:18px;text-align:center;font-size:12px;color:var(--muted)}
      .dot{width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;margin-right:6px;box-shadow:0 0 0 3px rgba(34,197,94,.15)}
      @media (prefers-color-scheme: dark){
        :root{--bg:#0b1220;--surface:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--primary:#10b981;--primary-600:#0ca678;--accent:#f59e0b}
        .card,.cell{border-color:#1f2937}
        .cell .t{color:#000000 !important}
      }
    </style>
    <script>
      // Config
      const API_BASE = 'https://new-production-1016.up.railway.app';
      const VAKIT_BASE = 'https://vakit.vercel.app';

      // RN bridge helpers
      function postToRN(type, payload){
        try{window.ReactNativeWebView && window.ReactNativeWebView.postMessage(JSON.stringify({type,payload}));}catch(_){/* noop */}
      }

      // Compute next prayer
      function computeNext(times){
        const order = [["İmsak",times.imsak],["Güneş",times.gunes],["Öğle",times.ogle],["İkindi",times.ikindi],["Akşam",times.aksam],["Yatsı",times.yatsi]];
        const now = new Date();
        for(const [n,v] of order){
          if(!v) continue; const [hh,mm] = String(v).split(":").map(Number); const d = new Date(); d.setHours(hh,mm,0,0); if(d>=now){
            return {name:n,time:`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`,remaining_minutes:Math.floor((d-now)/60000)}
          }
        }
        if(times.imsak){const [hh,mm]=String(times.imsak).split(":").map(Number); const d=new Date(Date.now()+86400000); d.setHours(hh,mm,0,0);return {name:"İmsak",time:`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`,remaining_minutes:Math.floor((d-new Date())/60000)}}
        return null;
      }

      async function getCoords(){
        // Prefer RN-provided location via injected bridge. If not, try Geolocation, lastly IP.
        return new Promise((resolve)=>{
          let resolved=false;
          // Geolocation
          if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition((pos)=>{ if(resolved) return; resolved=true; resolve({lat:pos.coords.latitude,lng:pos.coords.longitude,label:'GPS'}); },()=>{}, {enableHighAccuracy:true,timeout:7000,maximumAge:60000});
          }
          // Fallback: IP
          setTimeout(async()=>{
            if(resolved) return; try{ const r = await fetch(`${VAKIT_BASE}/api/ip`); if(r.ok){ const j=await r.json(); resolved=true; resolve({lat:j.lat,lng:j.lng,label:'IP'}) } }catch(_){}
            if(!resolved){resolved=true; resolve(null)}
          }, 2500);
        });
      }

      async function loadTimes(lat,lng){
        const tz = -new Date().getTimezoneOffset();
        const d = new Date().toISOString().slice(0,10);
        const u = new URL(`${VAKIT_BASE}/api/timesForGPS`);
        u.searchParams.set('lat',String(lat)); u.searchParams.set('lng',String(lng));
        u.searchParams.set('date',d); u.searchParams.set('days','1'); u.searchParams.set('timezoneOffset',String(tz)); u.searchParams.set('calculationMethod','Turkey'); u.searchParams.set('lang','tr');
        const res = await fetch(u.toString()); if(!res.ok) throw new Error('Vakit servisi hatası'); const p = await res.json();
        let mapped={};
        if(p?.times && !Array.isArray(p.times)){
          const dk = Object.keys(p.times)[0]; const arr = p.times[dk]||[]; const clean = (t)=> (t?String(t).split(' ')[0]:null);
          mapped = {imsak:clean(arr[0]),gunes:clean(arr[1]),ogle:clean(arr[2]),ikindi:clean(arr[3]),aksam:clean(arr[4]),yatsi:clean(arr[5])};
        }else{
          const f = Array.isArray(p?.times) ? (p.times[0]||{}) : (p?.data||{}); const c=(t)=> (t?String(t).split(' ')[0]:null);
          mapped = {imsak:c(f.fajr||f.imsak||f.Fajr), gunes:c(f.sunrise||f.gunes||f.Sunrise), ogle:c(f.dhuhr||f.ogle||f.Dhuhr), ikindi:c(f.asr||f.ikindi||f.Asr), aksam:c(f.maghrib||f.aksam||f.Maghrib), yatsi:c(f.isha||f.yatsi||f.Isha)};
        }
        return mapped;
      }

      function loadFromCache(){
        try{
          const raw = localStorage.getItem('namaz_cache_v1');
          if(!raw) return null; const j = JSON.parse(raw);
          if(!j || !j.times) return null; return j;
        }catch(_){ return null }
      }

      function saveToCache(times, meta){
        try{ localStorage.setItem('namaz_cache_v1', JSON.stringify({ times, meta, ts: Date.now() })); }catch(_){ }
      }

      function setOnlineBadge(ok){
        const status = document.getElementById('status');
        if(!status) return; if(ok){ status.innerHTML = '<span class="dot"></span>Hazır'; } else { status.innerHTML = 'Çevrimdışı'; status.style.color = '#b91c1c'; }
      }

      async function main(){
        const el = (id)=>document.getElementById(id);
        const status = el('status'); const grid = el('grid'); const next = el('next'); const err = el('error');
        const addWidgetBtn = el('btn-add-widget');
        const preMinutesInput = el('pre-min');
        const ezanToggle = el('ezan-toggle');
        const pImsak = el('p-imsak'); const pGunes = el('p-gunes'); const pOgle = el('p-ogle'); const pIkindi = el('p-ikindi'); const pAksam = el('p-aksam'); const pYatsi = el('p-yatsi');
        const homeBtn = el('btn-home'); const homeCountdown = el('home-count');
        // 1) Try cached instantly
        const cached = loadFromCache();
        if(cached && cached.times){
          const keys = [["İmsak","imsak","🌙"],["Güneş","gunes","☀️"],["Öğle","ogle","🕛"],["İkindi","ikindi","🕒"],["Akşam","aksam","🌇"],["Yatsı","yatsi","🌙"]];
          grid.innerHTML = keys.map(([n,k,ic])=>`<div class="cell"><div class="n"><span class="i">${ic}</span>${n}</div><div class="t">${cached.times[k]||'--:--'}</div></div>`).join('');
          const nxt = computeNext(cached.times); if(nxt){ next.textContent = `Sıradaki: ${nxt.name} - ${nxt.time} (${nxt.remaining_minutes} dk)`; }
          setOnlineBadge(navigator.onLine);
        } else {
          status.innerHTML = '<span class="dot"></span>Hazır';
        }
        try{
          const coords = await getCoords();
          if(!coords) throw new Error('Konum alınamadı');
          const times = await loadTimes(coords.lat, coords.lng);
          const keys = [["İmsak","imsak","🌙"],["Güneş","gunes","☀️"],["Öğle","ogle","🕛"],["İkindi","ikindi","🕒"],["Akşam","aksam","🌇"],["Yatsı","yatsi","🌙"]];
          grid.innerHTML = keys.map(([n,k,ic])=>`<div class="cell"><div class="n"><span class="i">${ic}</span>${n}</div><div class="t">${times[k]||'--:--'}</div></div>`).join('');
          const nxt = computeNext(times);
          if(nxt){ next.textContent = `Sıradaki: ${nxt.name} - ${nxt.time} (${nxt.remaining_minutes} dk)`; }
          // 2) Save cache and sync to RN widget immediately
          saveToCache(times, { coords });
          // Default snapshot: 15 dk önce + ezan açık + tüm vakitler açık
          const snapshot = {
            before_minutes: Number(preMinutesInput.value||15),
            ezanEnabled: ezanToggle.checked,
            prayers: {
              imsak: pImsak.checked, gunes: pGunes.checked, ogle: pOgle.checked,
              ikindi: pIkindi.checked, aksam: pAksam.checked, yatsi: pYatsi.checked
            },
            times: times,
            label: coords?.label || ''
          };
          postToRN('notify:set', snapshot);
          postToRN('widget:update', { times, label: coords.label });
          setOnlineBadge(true);
        }catch(e){
          err.textContent = 'Hata: ' + (e && e.message ? e.message : 'Bilinmeyen');
          err.style.display='block';
          setOnlineBadge(false);
        }

        // Buttons
        document.getElementById('btn-theme').addEventListener('click', function(){
          const theme = (matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'light' : 'dark';
          postToRN('widget:theme', theme);
        }, { passive: true });
        document.getElementById('btn-notify').addEventListener('click', function(){
          let cache = loadFromCache();
          const payload = {
            before_minutes: Number(preMinutesInput.value||15),
            ezanEnabled: ezanToggle.checked,
            prayers: {
              imsak: pImsak.checked, gunes: pGunes.checked, ogle: pOgle.checked,
              ikindi: pIkindi.checked, aksam: pAksam.checked, yatsi: pYatsi.checked
            },
            times: cache?.times || undefined,
            label: cache?.meta?.coords?.label || ''
          };
          postToRN('notify:set', payload);
        }, { passive: true });
        document.getElementById('btn-settings').addEventListener('click', function(){ postToRN('device:openSettings', {}); }, { passive: true });
        addWidgetBtn.addEventListener('click', function(){ postToRN('widget:add', {}); }, { passive: true });

        // Big Home CTA + auto-redirect after 15s if user does not act
        let secs = 15; homeCountdown.textContent = secs;
        const tick = ()=>{ secs-=1; if(secs<=0){ location.href = '/'; } else { homeCountdown.textContent = secs; setTimeout(tick,1000);} };
        setTimeout(tick,1000);
        homeBtn.addEventListener('click', function(){ location.href = '/'; });
      }
      window.addEventListener('load', main);
      window.addEventListener('online', ()=> setOnlineBadge(true));
      window.addEventListener('offline', ()=> setOnlineBadge(false));
    </script>
  </head>
  <body>
    <div class="container">
      
      <div class="card">
        <div class="next" id="next">Sıradaki: …</div>
        <div class="grid" id="grid"></div>
        <div class="card" style="margin-top:10px; background:#f9fcfb; color:#0f172a; border:1px solid #e6f0ec">
          <div style="font-weight:900;margin-bottom:6px">📱 3x2 Namaz Widget Ekleyin</div>
          <div style="font-size:12px;opacity:0.85;margin-bottom:10px">Sıradaki vakit, kalan süre ve Hicri tarihi ana ekranda görün.</div>
          <button class="btn" id="btn-add-widget">Widget'ı Ana Ekrana Ekle</button>
          <div style="font-size:12px;opacity:0.95;margin-top:10px">Varsayılan: <b>15 dk önce bildirim</b> ve <b>ezan sesi açık</b>. İsterseniz aşağıdan değiştirin.</div>
        </div>

        <!-- Per-vakit bildirim tercihleri -->
        <div class="card" aria-labelledby="notify-heading">
          <div class="row"><div class="k" id="notify-heading">Bildirim Ayarları</div></div>
          <div class="row">
            <label for="pre-min">Önceden uyar (dk)</label>
            <div>
              <input id="pre-min" type="number" value="15" min="0" max="60" style="width:64px" title="Vakitten önce uyarı dakikası" aria-label="Vakitten önce uyarı dakikası" placeholder="15" />
            </div>
          </div>
          <div class="row">
            <label for="ezan-toggle">Ezan sesi</label>
            <div>
              <input id="ezan-toggle" type="checkbox" checked title="Ezan sesini aç" aria-label="Ezan sesini aç" />
            </div>
          </div>
          <div class="row"><div class="k">Vakit Bazlı</div><div></div></div>
          <div class="row">
            <label for="p-imsak">İmsak</label>
            <div><input id="p-imsak" type="checkbox" checked title="İmsak bildirimi" aria-label="İmsak bildirimi" /></div>
          </div>
          <div class="row">
            <label for="p-gunes">Güneş</label>
            <div><input id="p-gunes" type="checkbox" checked title="Güneş bildirimi" aria-label="Güneş bildirimi" /></div>
          </div>
          <div class="row">
            <label for="p-ogle">Öğle</label>
            <div><input id="p-ogle" type="checkbox" checked title="Öğle bildirimi" aria-label="Öğle bildirimi" /></div>
          </div>
          <div class="row">
            <label for="p-ikindi">İkindi</label>
            <div><input id="p-ikindi" type="checkbox" checked title="İkindi bildirimi" aria-label="İkindi bildirimi" /></div>
          </div>
          <div class="row">
            <label for="p-aksam">Akşam</label>
            <div><input id="p-aksam" type="checkbox" checked title="Akşam bildirimi" aria-label="Akşam bildirimi" /></div>
          </div>
          <div class="row">
            <label for="p-yatsi">Yatsı</label>
            <div><input id="p-yatsi" type="checkbox" checked title="Yatsı bildirimi" aria-label="Yatsı bildirimi" /></div>
          </div>
          <div class="muted">Not: Bu tercihler RN uygulamasına iletilir ve alarm planlama buna göre yapılır.</div>
        </div>
        <div class="toolbar">
          <button class="btn" id="btn-theme">Tema</button>
          <button class="btn secondary" id="btn-notify">Bildirim</button>
          <button class="btn warn" id="btn-settings">Ayarlar</button>
        </div>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn big" id="btn-home">Ana Sayfaya Geç (<span id="home-count">15</span>)</button>
        </div>
        <div class="error" id="error" style="display:none"></div>
        <div class="muted">GPS/IP ile bulunduğunuz konuma göre hesaplanır. İnternet yoksa son veriler önbellekten gösterilir.</div>
      </div>
      <div class="footer">Mihmandar • mobil yardımcı sayfa</div>
    </div>
  </body>
  </html>